# Materials and Methods {#materials-and-methods}

\begin{figure}
\centering
\includegraphics[width=\columnwidth]{../analysis/figures/map_graves.jpeg}
\caption{\label{map_graves}All graves dating between 2200 and 800calBC as extracted from the Radon-B database (\url{radon-b.ufg.uni-kiel.de}). The classes of the variable \textit{burial type} are distinguished by colour, the ones of \textit{burial construction} by shape. The rectangular frame indicates the research area. The Map projection is EPSG:102013 and the base layer (land, rivers, lakes) data is taken from Natural Earth project (\url{www.naturalearthdata.com}).}
\end{figure}

The code of this paper is written in the statistical programming language R [@rcoreteamLanguageEnvironmentStatistical2018] and fully reproducible. A more in-depth description and discussion of the data preparation steps can be found in the master thesis this article is based on [@schmidComputerbasiertesCulturalEvolution2018].

## Data

The dataset used for the analysis in this paper is a subset of the openly available database Radon-B [@kneiselRadonB2013]. It contains ^14^C dates from the European Bronze and Early Iron Age (approximately 2300 BC to 500 BC). Radiocarbon dating is a crucial absolute dating technique for this period [@ramseyRadiocarbonDatingRevolutions2008], and Radon-B is a collection of more than 11000 published dates from around 2800 sites located all over Europe (as of December 2018). Beyond the identifying laboratory number, the actual, uncalibrated date and a literature reference, the ^14^C dates in Radon-B are also documented with context information about the name and location of the dated site (coordinates), the sample material and the type and cultural attribution of the sampled context. The variable *feature type* systematically distinguishes between settlements, rock shelters and also different kinds of graves: *Grave (cremation), Grave (flat) inhumation*, i.a.. This information allows to accurately and precisely determine a moment in space and time when a grave of a particular type was created. In theory, the more radiocarbon dates with this information are available, the better becomes our understanding and reconstruction of burial traditions in prehistoric Europe. Unfortunately, the Radon-B dataset has some quality issues mostly due to inconsistent manual data input: Incompleteness and faultiness of meta information, no supervised or well-thought-out variable classification for *sample material* and *cultural attribution* and inconsistent multilingualism even within individual entries. These issues though do not inhibit the general data analysis strategy of this paper.

## Data preparation 

To create a tidy and useful subset of Radon-B, the following steps of data preparation were applied. Please see the code for details of implementation. The value in brackets indicates the number of dates or graves still available after the respective filtering operation.

1. Downloading the Radon-B dataset with the R package c14bazAAR [@schmidC14bazAARDownloadPrepare2018], which allows to access several open radiocarbon archives. (`r r("size radonb", sf_prep)` dates)

2. Removing all dates without age information or age information outside of the limits of the Intcal13 calibration curve: 71 - 46401 BP [@reimer_intcal13_2013]. (`r r("size bronze", sf_prep)` dates)

3. Calibrating the ^14^C dates with the R package Bchron [@haslettSimpleMonotoneProcess2008], which implements a calibration algorithm based on numerical integration.

4. Reducing date selection to all dates whose $2\sigma$ calibrated age range overlap by at least one year with the predefined window of interest: 2200 -- 800 calBC. (`r r("size bronze0", sf_prep)` dates)

5. Reducing the date selection to all dates taken from graves as indicated by the *feature type* variable. (`r r("size bronze05", sf_prep)` dates)

6. Transforming the variable *feature type* via pattern matching to two new variables *burial type* (inhumation/cremation/unknown) and *burial construction* (mound/flat/unknown).

7. Manually defining a rectangular (in EPSG:102013) research area with sufficient information in Central-, Northern and Northwestern Europe based on perceived spatial data distribution (Figure \ref{map_graves}).

8. Reducing date selection to dates within the research area. (`r r("size bronze15", sf_prep)` dates)

9. Removing ^14^C date doubles with tools of c14bazAAR. (`r r("size bronze16", sf_prep)` dates)

10. Transforming data from the meaning *^14^C dates on graves* to *burial type at a certain time*. For `r r("bronze15 multi dates one grave", sf_prep)` entries in the thus far assembled subset the attribution to *site* and *feature* is not unique. That means that for many graves multiple (up to 8) ^14^C dates have been created (and entered in Radon-B) and dates therefore cannot be treated as semantically equal to graves. There is a variety of phenomena that cause this effect: In some cases, safety measurements were taken so that there are multiple dates for one single grave that all fall within the margin of errors of each other. In other cases, the set of dates for one grave strongly diverge because they cover the life cycle of a collective grave that was used for hundreds of years. There are also cases where the *feature* information in Radon-B is not sufficient to determine whether two dates are really from the same grave despite the identical entry. The following steps were applied to solve this problem algorithmically. The approach is compatible with the intention to create a cultural trait time series as explained below. (`r r("size bronze17", sf_prep)` graves)

    1. If for an individual ^14^C date no numbers appear in its *feature* variable value, then it is treated as an individual grave.
    
    2. For the remaining `r r("bronze16 multi dates one grave with numbers", sf_prep)` problematic cases, groups were created by *site* and *feature*. The cumulated timespan covered by the $2\sigma$ age range of all these dates were taken as the relevant timespan for the respective grave.

11. Defining macro-regions to observe the development of *burial type* and *burial construction* within sensible geographical and cultural units that are appropriate to the amount of available data. The regions are circular and were delimited semi-automatically by creating a regular grid in accordance to main cultural-historical regions of the European Bronze Age [@fokkensIntroductionBronzeAge2013]. The regions have a radius of 240km and overlap slightly (Figure \ref{map_regions} A). That means some graves are counted towards not only one but two regions.

12. Reducing the date selection to the space covered by the macro-regions and attributing the dates to the respective units. (`r r("gpr size", sf_desc)` graves)

\begin{figure}
\centering
\includegraphics[width=\columnwidth]{../analysis/figures/map_regions.jpeg}
\caption{\label{map_regions}Circular, artificial regions (\textbf{A}) and spatial distance network with classified distance values (\textbf{B}). The map layout is similar to Figure \ref{map_graves} but instead of rivers modern country borders are drawn.}
\end{figure}

The resulting dataset is structured as a table with `r r("gpr size", sf_desc)` rows each representing one grave as compiled by `r r("dpr size", sf_desc)` ^14^C dates from `r r("dpr sites amount", sf_desc)` sites. The graves are linked to `r r("dpr period amount", sf_desc)` different *period* terms and `r r("dpr culture amount", sf_desc)` different archaeological *cultures* as they are distinguished in Radon-B. `r r("dpr material bone amount", sf_desc)` dates were measured on sample material of bones and teeth (at least `r r("dpr material cremated bones amount", sf_desc)` of them burnt), `r r("dpr material charcoal wood amount", sf_desc)` on wood and charcoal, a small part (`r r("dpr material other amount", sf_desc)`) on other materials such as nuts, resin or pitch. For the remaining `r r("dpr material unknown amount", sf_desc)` dates, no material information is stored. Regarding the variables burial type and burial construction, the conditions shown in Table \ref{tab:dprcrosstab} apply. 

```{r dprcrosstab, echo=FALSE, tidy=FALSE}
load("../analysis/data/output_data/dprcrosstab.RData")
dprcrosstab %>% 
  unclass() %>% data.frame() %>% 
  knitr::kable(
    caption = "Burial rite distribution in the active dataset.",
    format = "latex",
    booktabs = T,
    escape = F,
    linesep = "\\addlinespace \\hline \\addlinespace",
    align = "l"
  ) %>%
  kableExtra::kable_styling(
    full_width = T, 
    font_size = 9,
    latex_options = "hold_position"
  ) %>%
  kableExtra::add_header_above(c("burial type" = 1, "burial construction" = 3))
```

## Time series

This data for individual graves can be transformed to a time series of trait prevalence within the respective regions. If a certain kind of grave can be attributed to a (fuzzy) point in time with radiocarbon dating, then we also know that most likely a ceremony was held around this time where the particular burial tradition was practised. That means that the cultural trait behind this behaviour must also have been present in one form or the other. An example: The idea *inhumation* must have been present in 1447 calBC in Great Britain since this year lies in the $2\sigma$ age range of the ^14^C date *NZA-32497* taken from the Amesbury Down inhumation burial *I2639/25217*. For each year in the time frame 2200 -- 800 calBC we can count the number of graves with dates that cover this year with their $2\sigma$ age range. That allows the construction of region wise time series of absolute occurrence numbers for the variables *burial type* and *burial construction* (Figure \ref{development_burial_type} and \ref{development_burial_construction}). Although the number of dates is tiny for some regions and periods, we still can attempt to calculate relative proportions of the mutually exclusive traits (inhumation vs cremation and mound grave vs flat grave). That leads to relative time series of trait prevalence, which could be a powerful proxy for the development of the distribution of cultural behaviour.

\begin{figure}
\centering
\includegraphics[width=\columnwidth]{../analysis/figures/development_burial_type.jpeg}
\caption{\label{development_burial_type}Regional distribution time series of the variable \textit{burial type} with the absolute amount (\textbf{A}) and proportion (\textbf{B}) of grave types. The x-axis shows the time, the y-axis the amount or the percentage shares of graves. The individual plots are separated by region, and each region is featured by a small map according to Figure \ref{map_regions} A.}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\columnwidth]{../analysis/figures/development_burial_construction.jpeg}
\caption{\label{development_burial_construction}Like Figure \ref{development_burial_type}, but for the variable \textit{burial construction}.\newline\newline\newline\newline\newline}
\end{figure}

## Cultural distance

These time series also allow to derive another set of time series with a measure of cultural distance for each region-region relationship (Figure \ref{sed_region_matrix}). Cultural distance is defined here as the squared Euclidean distance (SED) between the trait proportions of two different regions at a certain point in time [@neimanStylisticVariationEvolutionary1995]. SED seems to be a sensible statistic here, because it is relatively simple, works with only a few assumptions and emphasises differences through squaring.

\begin{figure*}
\centering
\includegraphics[width=\textwidth]{../analysis/figures/sed_region_matrix.jpeg}
\caption{\label{sed_region_matrix}Plot matrix of the region-region squared Euclidean distance time series. In the top right half with solid lines for the variable \textit{burial type} and in the bottom left with dashed lines for the variable \textit{burial construction}. The x-axis displays time, the y-axis the squared Euclidean distance between two relevant regions. The faint line shows the actual data, the stronger line an approximation (LOESS with $span = 0.3$).}
\end{figure*}

$$
d_{ij}^2 = \sum_{k = 1}^{n} (p_{ik} - p_{jk})^2
$$

- $d_{ij}^2$: SED between two groups $i$ and $j$

- $k$: trait counter 

- $n$: number of traits in the population

- $p_{ik}$: relative frequency of the $k$th trait in group $i$

- $p_{jk}$: relative frequency of the $k$th trait in group $j$

To test for correlation between the distances based on the variables *burial type* and *burial construction*, the time frame of interest was divided into sections of 200 years. For each of the $1400/200 = 7$ section and each of the two variables, a matrix of the mean SED over time was calculated. The two matrices of each section can be tested for correlation with the Mantel test, which uses permutations of allegedly correlating matrices to determine how strongly random reordering can alter an underlying correlation coefficient [@mantelDetectionDiseaseClustering1967]. Since both distances compared here, *burial type* and *burial construction* distance, are cardinal scale variables, the Pearson correlation coefficient [@pearsonNotesRegressionInheritance1895] can be applied as a base measure for the Mantel test (Table \ref{tab:distanceandcorrelationtable*} C). 

Defining a measure of spatial distance for the above established main units of observation, the macro-regions, is only possible in a highly simplified way. A continuous distance measure cannot be employed, but it is possible to distinguish ordinal distance classes. For the eight regions, four different categories of spatial distance were defined (Figure \ref{map_regions} B). The test for correlation between spatial and cultural distance works similar to the one between the two cultural distances above, except that the Mantel test has to be applied with Spearman's rank correlation coefficient [@spearmanProofMeasurementAssociation1904] here, because of the different data levels of the measurements (Table \ref{tab:distanceandcorrelationtable*} AB).

```{r distanceandcorrelationtable, echo=FALSE, tidy=FALSE}
load("../analysis/data/output_data/distance_and_correlation_table.RData")
distance_and_correlation_table %>%
  dplyr::mutate_at(
    dplyr::vars(dplyr::matches("Mean|Correlation")),
    dplyr::funs(kableExtra::cell_spec(., "latex", color = ifelse(. < 0, "red", "black"))) 
  ) %>%
  dplyr::mutate_at(
    dplyr::vars(dplyr::matches("p-Value")),
    dplyr::funs(kableExtra::cell_spec(., "latex", bold = . < 0.1)) 
  ) %>%
knitr::kable(
  "latex", 
  caption = "Mean distance, correlation and mantel test results for cultural and spatial distance. Listed are the the overall mean squared Euclidian distances for each 200 years time slot of all region-region relations and the result statistics of the Mantel test for the variables \\textit{burial type (bt)} (\\textbf{A}) and \\textit{burial construction (bc)} (\\textbf{B}) with the spatial (sp) distance matrix (Figure \\ref{map_regions} B). \\textbf{C} shows the Mantel test results for the two variables if compared directly. $p$-values below $0.1$ are printed bold.", 
  booktabs = T,
  linesep = "\\addlinespace \\hline \\addlinespace",
  escape = F
) %>%
  kableExtra::add_header_above(
    c(" ", "burial type & spatial distance" = 3, "burial construction & spatial distance" = 3, "variable correlation" = 2)
  ) %>%
  kableExtra::add_header_above(
    c(" ", "A" = 3, "B" = 3, "C" = 2),
    bold = T, line = F
  ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position"),
    font_size = 9,
    full_width = T
  ) %>%
  kableExtra::column_spec(c(2,4,5,7,9), width = "1.2cm") %>%
  kableExtra::column_spec(c(3,6,8), width = "1.8cm") %>%
  gsub("table", "table*", .)
```

To get a better understanding how the correlation coefficient should develop if there was a strong correlation between spatial and cultural distance as measured by *burial type* and *burial construction*, a simple simulation was implemented based on the model proposed by @neimanStylisticVariationEvolutionary1995. This simulation assumes a population separated into $g = 8$ groups (regions) with $N_g = 100$ individuals each. $k = 2$ mutually exclusive ideas are randomly but equally distributed in this population at $t_{0}$. With every time step ($t_{total} = (2200 - 800)/20 = 70$) all individuals learn from another randomly chosen individual. Several different values where tested for the probability $m_i$ that the other agent the individual is learning from comes not from the same, but from another group: 

$$
m_i = 
  \begin{dcases*} 
    0 & Figure \ref{simulation} AB, no intergroup exchange \\ 
    0.05 & Figure \ref{simulation} CD \\
    0.5 & Figure \ref{simulation} EF, very high exchange
  \end{dcases*}
$$

The partner group for each learning instance is selected randomly following a group interaction probability matrix $I$. Two different matrices where tested:

$$
I =
  \begin{dcases*}
    \begin{matrix}
        & a & b & c & ... \\
      a & 0 & 1 & 1 & ... \\
      b & 1 & 0 & 1 & ...\\
      c & 1 & 1 & 0 & ... \\
      ... & ... & ... & ... & ...
    \end{matrix} \\
    \text{Figure \ref{simulation} ACEG, equal distance between groups a:h} \\
    \begin{matrix}
        & a & b       & c       & ... \\
      a & 0 & |b-a|^2 & |c-a|^2 & ... \\
      b & |a-b|^2 & 0 & |c-b|^2 & ... \\
      c & |a-c|^2 & |b-c|^2 & 0 & ... \\
      ... & ... & ... & ... & ...
    \end{matrix} \\
    \text{Figure \ref{simulation} BDFH, spatial distance (Figure \ref{map_regions} B)}
  \end{dcases*}
$$ 

The distribution of the $k$ variants within the groups can be observed for every time step and documented in time series just like the ones for the real-world regions data (Figure \ref{development_burial_type} B and \ref{development_burial_construction} B). These time series can as well be used to calculate time series of region-region distance, which again can be split up into time blocks of 200 years to calculate mean distance matrices. The latter can be checked for correlation with the spatial distance matrix (cf. Table \ref{tab:distanceandcorrelationtable*} AB) and compared with other simulation results and real-world observations (Figure \ref{simulation}).

\begin{figure*}
\centering
\includegraphics[width=\textwidth]{../analysis/figures/simulation.jpeg}
\caption{\label{simulation}Development of correlation between cultural and spatial distance for real world data and simulation results. The plots in the left column of the plot matrix (\textbf{ACE}) contain simulation results for an equal group distance matrix $I$, the ones on the right (\textbf{BDF}) for a distance matrix based on the macro unit distances defined for this paper (Figure \ref{map_regions} B). The rows of the plot matrix (\textbf{AB}, \textbf{CD}, \textbf{EF}) represent different degrees of intergroup transmission $m_i$. Each plot shows the results of 50 simulation runs. The x-axis displays the time distinguished into 200 year time slots, the y-axis Spearman's rank correlation coefficient between the mean squared Euclidean distance matrix for a 200 year time slot and the static spatial distance matrix. This information is visualized for each time slot with (from left to right) a dotplot coloured according to the $p$-value of the Mantel test, a scatter plot line and a boxplot. The scatter plot points of one simulation run are connected with a faint line from one time slot to the next. To compare the runs with the real world observations, the results for the burial customs data (Table \ref{tab:distanceandcorrelationtable*} AB) is added here with with a stronger solid (\textit{burial type}) and dashed (\textit{burial construction}) line. The strong horizontal line marks the correlation coefficient of zero, where neither positive nor negative correlation can be assumed.}
\end{figure*}
